---
layout: default
title: GitHub Actions Integration
---

<div class="documentation">
  <h1>GitHub Actions Integration</h1>
  
  <p>Rails Migration Guard provides seamless integration with GitHub Actions to automatically check for migration issues in your CI/CD pipeline. This guide covers setup, configuration, and best practices.</p>
  
  <div class="table-of-contents">
    <h2>Table of Contents</h2>
    <ol>
      <li><a href="#basic-setup">Basic Setup</a></li>
      <li><a href="#configuration-options">Configuration Options</a></li>
      <li><a href="#exit-codes">Exit Codes</a></li>
      <li><a href="#database-services">Database Services</a></li>
      <li><a href="#advanced-examples">Advanced Examples</a></li>
      <li><a href="#json-output">Parsing JSON Output</a></li>
      <li><a href="#best-practices">Best Practices</a></li>
      <li><a href="#troubleshooting">Troubleshooting</a></li>
    </ol>
  </div>
  
  <section id="basic-setup">
    <h2>Basic Setup</h2>
    
    <p>Add this workflow to your repository to check for migration issues on every pull request:</p>
    
    <pre><code># .github/workflows/migration-check.yml
name: Migration Check

on:
  pull_request:
    branches: [ main, master ]

jobs:
  check-migrations:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for branch comparison
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      
      - name: Setup database
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
          RAILS_ENV: test
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load
      
      - name: Check for migration issues
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test
          RAILS_ENV: test
        run: |
          bundle exec rails db:migration:ci --strict</code></pre>
    
    <h3>Using the Built-in Action</h3>
    
    <p>Rails Migration Guard also includes a GitHub Action that provides additional features like PR comments:</p>
    
    <pre><code>- name: Check migrations
  uses: ./.github/actions/migration-guard
  with:
    strict: false               # Only fail on errors, not warnings
    comment-on-pr: true        # Add comments to PRs
    format: json               # Use JSON output for parsing</code></pre>
  </section>
  
  <section id="configuration-options">
    <h2>Configuration Options</h2>
    
    <h3>Command Line Options</h3>
    
    <table>
      <thead>
        <tr>
          <th>Option</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>--strict</code></td>
          <td>Fail on warnings (not just errors)</td>
          <td>false</td>
        </tr>
        <tr>
          <td><code>--format</code></td>
          <td>Output format (text/json)</td>
          <td>text</td>
        </tr>
      </tbody>
    </table>
    
    <h3>Environment Variables</h3>
    
    <table>
      <thead>
        <tr>
          <th>Variable</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>RAILS_ENV</code></td>
          <td>Rails environment</td>
          <td>test</td>
        </tr>
        <tr>
          <td><code>DATABASE_URL</code></td>
          <td>Database connection string</td>
          <td>From database.yml</td>
        </tr>
      </tbody>
    </table>
  </section>
  
  <section id="exit-codes">
    <h2>Exit Codes</h2>
    
    <p>The CI command returns different exit codes based on the check results:</p>
    
    <ul>
      <li><code>0</code> - No issues found</li>
      <li><code>1</code> - Warnings found (orphaned migrations)</li>
      <li><code>2</code> - Errors found (missing migrations or critical issues)</li>
    </ul>
    
    <p>Use <code>--strict</code> to treat warnings as failures (exit code 1).</p>
  </section>
  
  <section id="database-services">
    <h2>Database Services</h2>
    
    <h3>PostgreSQL</h3>
    
    <pre><code>services:
  postgres:
    image: postgres:14
    env:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    options: >-
      --health-cmd pg_isready
      --health-interval 10s
      --health-timeout 5s
      --health-retries 5
    ports:
      - 5432:5432

env:
  DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db</code></pre>
    
    <h3>MySQL</h3>
    
    <pre><code>services:
  mysql:
    image: mysql:8
    env:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: test_db
    options: >-
      --health-cmd="mysqladmin ping"
      --health-interval=10s
      --health-timeout=5s
      --health-retries=3
    ports:
      - 3306:3306

env:
  DATABASE_URL: mysql2://root:password@localhost:3306/test_db</code></pre>
    
    <h3>SQLite</h3>
    
    <p>SQLite requires no additional services:</p>
    
    <pre><code>env:
  DATABASE_URL: sqlite3:db/test.sqlite3
  RAILS_ENV: test</code></pre>
  </section>
  
  <section id="advanced-examples">
    <h2>Advanced Examples</h2>
    
    <h3>Matrix Testing</h3>
    
    <p>Test across multiple Ruby and Rails versions:</p>
    
    <pre><code>strategy:
  matrix:
    ruby: ['3.1', '3.2', '3.3']
    rails: ['7.0', '7.1', '7.2']
    
steps:
  - uses: ruby/setup-ruby@v1
    with:
      ruby-version: ${{ matrix.ruby }}
      bundler-cache: true
  
  - name: Check migrations
    run: bundle exec rails db:migration:ci</code></pre>
    
    <h3>Conditional Checks</h3>
    
    <p>Only run when migrations change:</p>
    
    <pre><code>on:
  pull_request:
    paths:
      - 'db/migrate/**'
      - 'db/schema.rb'
      - 'db/structure.sql'</code></pre>
    
    <h3>Scheduled Monitoring</h3>
    
    <p>Check for drift in staging environments:</p>
    
    <pre><code>on:
  schedule:
    - cron: '0 9 * * 1-5'  # 9 AM UTC on weekdays
    
jobs:
  check-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Check staging migrations
        env:
          RAILS_ENV: staging
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: bundle exec rails db:migration:ci</code></pre>
  </section>
  
  <section id="json-output">
    <h2>Parsing JSON Output</h2>
    
    <p>Use JSON format for advanced workflows:</p>
    
    <pre><code>- name: Check migrations
  id: migration_check
  env:
    DATABASE_URL: ${{ secrets.DATABASE_URL }}
  run: |
    bundle exec rails db:migration:ci --format json > result.json || true
    echo "orphaned_count=$(jq '.orphaned | length' result.json)" >> $GITHUB_OUTPUT
    echo "missing_count=$(jq '.missing | length' result.json)" >> $GITHUB_OUTPUT
    
- name: Comment on PR
  if: steps.migration_check.outputs.orphaned_count > 0
  uses: actions/github-script@v6
  with:
    script: |
      github.rest.issues.createComment({
        issue_number: context.issue.number,
        owner: context.repo.owner,
        repo: context.repo.repo,
        body: '⚠️ Found ${{ steps.migration_check.outputs.orphaned_count }} orphaned migrations'
      })</code></pre>
    
    <h3>JSON Output Format</h3>
    
    <pre><code>{
  "status": "warning",
  "orphaned": [
    {
      "version": "20240115123456",
      "name": "add_user_profiles",
      "branch": "feature/profiles",
      "author": "developer@example.com"
    }
  ],
  "missing": [],
  "synced": ["20240110111111", "20240112222222"]
}</code></pre>
  </section>
  
  <section id="best-practices">
    <h2>Best Practices</h2>
    
    <ul>
      <li><strong>Always use <code>fetch-depth: 0</code></strong> - The gem needs full git history to compare branches</li>
      <li><strong>Start without <code>--strict</code></strong> - Get warnings first, then enforce strict mode</li>
      <li><strong>Cache dependencies</strong> - Use <code>bundler-cache: true</code> for faster builds</li>
      <li><strong>Use secrets for database URLs</strong> - Never hardcode credentials in workflows</li>
      <li><strong>Run in parallel</strong> - Migration checks can run alongside your test suite</li>
      <li><strong>Monitor scheduled checks</strong> - Set up notifications for drift detection</li>
    </ul>
    
    <h3>Security Considerations</h3>
    
    <pre><code>permissions:
  contents: read        # Read repository code
  pull-requests: write  # Comment on PRs (if using action)
  
env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}  # Never hardcode</code></pre>
  </section>
  
  <section id="troubleshooting">
    <h2>Troubleshooting</h2>
    
    <h3>Common Issues</h3>
    
    <h4>"fetch-depth: 0 is required"</h4>
    
    <p>The gem needs full git history to compare branches:</p>
    
    <pre><code>- uses: actions/checkout@v4
  with:
    fetch-depth: 0  # Don't use shallow clone</code></pre>
    
    <h4>Database connection errors</h4>
    
    <p>Ensure your database service is healthy:</p>
    
    <pre><code>- name: Wait for PostgreSQL
  run: |
    until pg_isready -h localhost -p 5432; do
      echo "Waiting for PostgreSQL..."
      sleep 1
    done</code></pre>
    
    <h4>Permission denied for PR comments</h4>
    
    <p>When using the built-in action with PR comments:</p>
    
    <pre><code>permissions:
  contents: read
  pull-requests: write</code></pre>
    
    <h3>Debug Mode</h3>
    
    <p>Enable verbose output for troubleshooting:</p>
    
    <pre><code>- name: Check migrations (debug)
  env:
    RAILS_ENV: test
    MIGRATION_GUARD_DEBUG: true
  run: |
    bundle exec rails db:migration:ci --format text</code></pre>
  </section>
  
  <div class="next-steps">
    <h2>Next Steps</h2>
    
    <ul>
      <li><a href="/ci-integration.html">CI/CD Integration</a> - Learn about other CI systems</li>
      <li><a href="/configuration.html">Configuration</a> - Customize Rails Migration Guard settings</li>
      <li><a href="/examples/">Examples</a> - See more workflow examples</li>
    </ul>
  </div>
</div>